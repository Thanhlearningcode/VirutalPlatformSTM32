<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embedded Virtual Platform Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .container { max-width: 1000px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        h1 { text-align: center; }
        .module { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; }
        .module h2 { margin-top: 0; }
        label { display: block; margin: 8px 0 4px; }
        input, select, button { margin-bottom: 10px; }
        .status { font-size: 0.95em; color: #555; }
        .register-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .register-table th, .register-table td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; }
        .register-table th { background: #e9e9e9; }
        .log { background: #222; color: #eee; font-size: 0.95em; padding: 10px; border-radius: 6px; height: 120px; overflow-y: auto; margin-top: 20px; }
        .active { box-shadow: 0 0 8px #2196f3; border-color: #2196f3; }
    </style>
</head>
<body>
<div class="container">
    <h1>Embedded Virtual Platform Simulator</h1>
    <div class="module" id="cpu">
        <h2>CPU (Cortex-M3)</h2>
        <button onclick="resetPlatform()">Reset</button>
        <button onclick="stepPlatform()">Step</button>
        <div class="status" id="cpu-status">Status: Ready</div>
        <table class="register-table" id="cpu-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>PC</td><td id="reg-pc">0x00000000</td></tr>
            <tr><td>SP</td><td id="reg-sp">0x00000000</td></tr>
            <tr><td>LR</td><td id="reg-lr">0x00000000</td></tr>
        </table>
    </div>
    <div class="module" id="uart">
        <h2>UART</h2>
        <label for="uart-baud">Baudrate:</label>
        <input type="number" id="uart-baud" value="9600" min="1200" max="115200" step="100" />
        <button onclick="setUARTBaud()">Set Baudrate</button>
        <label for="uart-send">Send Data:</label>
        <input type="text" id="uart-send" />
        <button onclick="sendUART()">Send</button>
        <button onclick="resetUART()">Reset UART</button>
        <button onclick="receiveUART()">Receive</button>
        <div class="status" id="uart-status">Status: Idle</div>
        <div class="status" id="uart-busy">Busy: false</div>
        <div class="status" id="uart-error">Error: false</div>
        <table class="register-table" id="uart-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>DR</td><td id="uart-dr">0x00</td></tr>
            <tr><td>SR</td><td id="uart-sr">0x00</td></tr>
        </table>
        <div class="status" id="uart-recv">Received Data: </div>
    </div>
    <div class="module" id="spi">
        <h2>SPI</h2>
        <label for="spi-speed">Speed (Hz):</label>
        <input type="number" id="spi-speed" value="1000000" min="10000" max="10000000" step="10000" />
        <button onclick="setSPISpeed()">Set Speed</button>
        <label for="spi-mode">Mode:</label>
        <select id="spi-mode"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
        <button onclick="setSPIMode()">Set Mode</button>
        <label for="spi-send">Send Data:</label>
        <input type="text" id="spi-send" />
        <button onclick="sendSPI()">Send</button>
        <button onclick="resetSPI()">Reset SPI</button>
        <button onclick="receiveSPI()">Receive</button>
        <div class="status" id="spi-status">Status: Idle</div>
        <div class="status" id="spi-busy">Busy: false</div>
        <div class="status" id="spi-error">Error: false</div>
        <table class="register-table" id="spi-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>DR</td><td id="spi-dr">0x00</td></tr>
            <tr><td>SR</td><td id="spi-sr">0x00</td></tr>
        </table>
        <div class="status" id="spi-recv">Received Data: </div>
    </div>
    <div class="module" id="i2c">
        <h2>I2C</h2>
        <label for="i2c-speed">Speed (Hz):</label>
        <input type="number" id="i2c-speed" value="100000" min="1000" max="1000000" step="1000" />
        <button onclick="setI2CSpeed()">Set Speed</button>
        <label for="i2c-addr">Address:</label>
        <input type="text" id="i2c-addr" value="0x00" />
        <button onclick="setI2CAddr()">Set Address</button>
        <label for="i2c-send">Send Data:</label>
        <input type="text" id="i2c-send" />
        <button onclick="sendI2C()">Send</button>
        <button onclick="resetI2C()">Reset I2C</button>
        <button onclick="receiveI2C()">Receive</button>
        <div class="status" id="i2c-status">Status: Idle</div>
        <div class="status" id="i2c-busy">Busy: false</div>
        <div class="status" id="i2c-error">Error: false</div>
        <table class="register-table" id="i2c-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>DR</td><td id="i2c-dr">0x00</td></tr>
            <tr><td>SR</td><td id="i2c-sr">0x00</td></tr>
        </table>
        <div class="status" id="i2c-recv">Received Data: </div>
    </div>
    <div class="module" id="timer">
        <h2>Timer</h2>
        <label for="timer-value">Set Timer Value:</label>
        <input type="number" id="timer-value" min="0" />
        <button onclick="setTimer()">Set</button>
        <button onclick="startTimer()">Start</button>
        <button onclick="stopTimer()">Stop</button>
        <button onclick="resetTimer()">Reset Timer</button>
        <div class="status" id="timer-status">Status: Stopped</div>
        <div class="status" id="timer-running">Running: false</div>
        <div class="status" id="timer-int">Interrupt: false</div>
        <table class="register-table" id="timer-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>CNT</td><td id="timer-cnt">0</td></tr>
            <tr><td>SR</td><td id="timer-sr">0x00</td></tr>
        </table>
    </div>
    <div class="module" id="dma">
        <h2>DMA</h2>
        <label for="dma-send">Send Data:</label>
        <input type="text" id="dma-send" />
        <button onclick="sendDMA()">Send</button>
        <div style="margin-top:8px">
            <label for="dma-uart-cmar">UART -> DMA dest (SRAM addr):</label>
            <input type="number" id="dma-uart-cmar" value="128" />
            <label for="dma-uart-cndtr">Length:</label>
            <input type="number" id="dma-uart-cndtr" value="16" />
            <button onclick="uartToDma()">UART â†’ DMA</button>
        </div>
        <div style="margin-top:8px">
            <h4>Manual DMA Transfer</h4>
            <label for="dma-cpar">CPAR (periph addr, hex):</label>
            <input type="text" id="dma-cpar" value="0x40000000" />
            <label for="dma-cmar">CMAR (sram addr):</label>
            <input type="number" id="dma-cmar" value="128" />
            <label for="dma-cndtr">COUNT:</label>
            <input type="number" id="dma-cndtr" value="16" />
            <button onclick="dmaTransfer()">Run DMA</button>
            <button onclick="sendUartAndDma()">Send UART & DMA</button>
        </div>
        <div class="status" id="dma-status">Status: Idle</div>
        <table class="register-table" id="dma-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>CCR</td><td id="dma-ccr">0x00</td></tr>
            <tr><td>CNDTR</td><td id="dma-cndtr">0x00</td></tr>
            <tr><td>CPAR</td><td id="dma-cpar">0x00</td></tr>
            <tr><td>CMAR</td><td id="dma-cmar">0x00</td></tr>
        </table>
    </div>

    <div class="module" id="can1">
        <h2>CAN1</h2>
        <label for="can1-baud">Baudrate:</label>
        <input type="number" id="can1-baud" value="500000" min="10000" max="1000000" step="10000" />
        <button onclick="setCANBaud(1)">Set Baudrate</button>
    <label for="can1-id">ID (hex):</label>
    <input type="text" id="can1-id" value="0x123" />
    <label for="can1-dlc">DLC:</label>
    <input type="number" id="can1-dlc" value="1" min="0" max="8" />
    <label><input type="checkbox" id="can1-ext" /> Extended ID</label>
    <label for="can1-tx">Transmit Data (hex bytes, comma separated):</label>
    <input type="text" id="can1-tx" placeholder="AA,BB" />
    <button onclick="sendCAN(1)">Transmit to CAN2</button>
        <button onclick="resetCAN(1)">Reset CAN1</button>
        <button onclick="receiveCAN(1)">Receive</button>
        <div class="status" id="can1-status">Status: Idle</div>
        <div class="status" id="can1-busy">Busy: false</div>
        <div class="status" id="can1-error">Error: false</div>
        <table class="register-table" id="can1-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>TX</td><td id="can1-txreg">0x00</td></tr>
            <tr><td>RX</td><td id="can1-rxreg">0x00</td></tr>
        </table>
        <div class="status" id="can1-recv">Received Data: </div>
    </div>

    <div class="module" id="can2">
        <h2>CAN2</h2>
        <label for="can2-baud">Baudrate:</label>
        <input type="number" id="can2-baud" value="500000" min="10000" max="1000000" step="10000" />
        <button onclick="setCANBaud(2)">Set Baudrate</button>
    <label for="can2-id">ID (hex):</label>
    <input type="text" id="can2-id" value="0x321" />
    <label for="can2-dlc">DLC:</label>
    <input type="number" id="can2-dlc" value="1" min="0" max="8" />
    <label><input type="checkbox" id="can2-ext" /> Extended ID</label>
    <label for="can2-tx">Transmit Data (hex bytes, comma separated):</label>
    <input type="text" id="can2-tx" placeholder="AA,BB" />
    <button onclick="sendCAN(2)">Transmit to CAN1</button>
        <button onclick="resetCAN(2)">Reset CAN2</button>
        <button onclick="receiveCAN(2)">Receive</button>
        <div class="status" id="can2-status">Status: Idle</div>
        <div class="status" id="can2-busy">Busy: false</div>
        <div class="status" id="can2-error">Error: false</div>
        <table class="register-table" id="can2-registers">
            <tr><th>Register</th><th>Value</th></tr>
            <tr><td>TX</td><td id="can2-txreg">0x00</td></tr>
            <tr><td>RX</td><td id="can2-rxreg">0x00</td></tr>
        </table>
        <div class="status" id="can2-recv">Received Data: </div>
    </div>
</div>
<script>
// Log area
let logArea;
window.onload = function() {
    logArea = document.createElement('div');
    logArea.className = 'log';
    logArea.id = 'log-area';
    logArea.innerHTML = '<b>Activity Log:</b><br>';
    document.body.appendChild(logArea);

    // Connect to server-sent events for real-time updates
    try {
        const es = new EventSource('/api/events');
        es.addEventListener('can', (e) => {
            try {
                const obj = JSON.parse(e.data);
                addLog('SSE CAN frame: from ' + obj.from + ' to ' + obj.to + ' data: ' + (obj.frame.data||[]).map(b=>('0x'+(b&0xFF).toString(16).padStart(2,'0'))).join(','));
                // populate destination RX register if UI visible
                if (obj.to === 1) {
                    document.getElementById('can1-rxreg').textContent = (obj.frame.data||[]).map(b=>('0x'+(b&0xFF).toString(16).padStart(2,'0'))).join(',');
                    can1RxData = document.getElementById('can1-rxreg').textContent;
                } else if (obj.to === 2) {
                    document.getElementById('can2-rxreg').textContent = (obj.frame.data||[]).map(b=>('0x'+(b&0xFF).toString(16).padStart(2,'0'))).join(',');
                    can2RxData = document.getElementById('can2-rxreg').textContent;
                }
            } catch (err) {
                console.error(err);
            }
        });
        es.onerror = (err) => { addLog('EventSource error'); };
    } catch (e) {
        addLog('SSE not supported');
    }
}

function toHex(b) {
    return ('0x' + (b & 0xFF).toString(16).toUpperCase().padStart(2, '0'));
}

function prettyDump(bytes) {
    if (!bytes) return '';
    const hex = [];
    const ascii = [];
    for (let i = 0; i < bytes.length; ++i) {
        const b = bytes[i] & 0xFF;
        hex.push(b.toString(16).toUpperCase().padStart(2,'0'));
        ascii.push((b >= 32 && b < 127) ? String.fromCharCode(b) : '.')
    }
    // group hex in hex pairs
    let hexStr = '';
    for (let i = 0; i < hex.length; i += 16) {
        hexStr += hex.slice(i, i+16).join(' ') + '\n';
    }
    return {hex: hexStr.trim(), ascii: ascii.join('')};
}

function dmaTransfer() {
    const cparRaw = document.getElementById('dma-cpar').value.trim();
    let cpar = 0;
    try { cpar = Number(cparRaw.startsWith('0x') ? parseInt(cparRaw,16) : parseInt(cparRaw,10)); } catch(e) { cpar = 0; }
    const cmar = parseInt(document.getElementById('dma-cmar').value) || 0;
    const cndtr = parseInt(document.getElementById('dma-cndtr').value) || 0;
    addLog('Manual DMA: CPAR=' + cparRaw + ' CMAR=' + cmar + ' COUNT=' + cndtr);
    apiCall('/api/dma', { action: 'transfer', cpar: cpar, cmar: cmar, cndtr: cndtr }, (resp) => {
        addLog('DMA resp: ' + JSON.stringify(resp));
        // read back SRAM
        fetch('/api/sram/read?addr=' + cmar + '&len=' + cndtr).then(r => r.json()).then(obj => {
            if (obj && obj.data) {
                const d = prettyDump(obj.data || []);
                document.getElementById('dma-status').textContent = 'SRAM['+obj.addr+'] hex:\n' + d.hex;
                addLog('SRAM dump:');
                addLog(d.hex.replace(/\n/g,' | '));
                addLog('ASCII: ' + d.ascii);
            } else {
                addLog('Readback failed');
            }
        }).catch(() => addLog('Error reading SRAM'));
    });
}

function sendUartAndDma() {
    // get UART data from the UI input
    const data = document.getElementById('uart-send').value || '';
    addLog('Send UART & DMA: sending UART data: ' + data);
    // first store UART data on server
    apiCall('/api/uart', { data: data }, (resp) => {
        addLog('UART stored (server): ' + JSON.stringify(resp));
        // then run DMA using current manual DMA fields
        dmaTransfer();
    });
}

function addLog(msg) {
    logArea.innerHTML += msg + '<br>';
    logArea.scrollTop = logArea.scrollHeight;
}

function highlightModule(id) {
    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    setTimeout(() => document.getElementById(id).classList.remove('active'), 600);
}

// REST API call (dummy)
function apiCall(endpoint, data, cb) {
    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(cb).catch(() => cb({}));
}

function resetPlatform() {
    document.getElementById('cpu-status').textContent = 'Status: Reset';
    addLog('CPU Reset');
    highlightModule('cpu');
    // Example REST call: apiCall('/api/reset', {}, (resp) => {...})
}
function stepPlatform() {
    document.getElementById('cpu-status').textContent = 'Status: Stepped';
    addLog('CPU Step');
    highlightModule('cpu');
    // Example REST call: apiCall('/api/step', {}, (resp) => {...})
}
let uartBusy = false;
let uartError = false;
let uartData = '';
let uartBaud = 9600;

function setUARTBaud() {
    uartBaud = parseInt(document.getElementById('uart-baud').value);
    addLog('UART Baudrate set: ' + uartBaud);
    highlightModule('uart');
}

function sendUART() {
    let data = document.getElementById('uart-send').value;
    uartBusy = true;
    document.getElementById('uart-status').textContent = 'Sent: ' + data;
    document.getElementById('uart-busy').textContent = 'Busy: true';
    addLog('UART Send: ' + data);
    highlightModule('uart');
    // Example REST call: apiCall('/api/uart', {data, baudrate: uartBaud}, (resp) => {...})
    setTimeout(() => {
        uartBusy = false;
        uartError = false;
        uartData = data;
        document.getElementById('uart-dr').textContent = data;
        document.getElementById('uart-sr').textContent = '0x01';
        document.getElementById('uart-busy').textContent = 'Busy: false';
        document.getElementById('uart-error').textContent = 'Error: false';
    }, 400);
}

function resetUART() {
    uartBusy = false;
    uartError = false;
    uartData = '';
    document.getElementById('uart-status').textContent = 'Status: Reset';
    document.getElementById('uart-busy').textContent = 'Busy: false';
    document.getElementById('uart-error').textContent = 'Error: false';
    document.getElementById('uart-dr').textContent = '0x00';
    document.getElementById('uart-sr').textContent = '0x00';
    document.getElementById('uart-recv').textContent = 'Received Data: ';
    addLog('UART Reset');
    highlightModule('uart');
}

function receiveUART() {
    document.getElementById('uart-recv').textContent = 'Received Data: ' + uartData;
    addLog('UART Receive: ' + uartData);
    highlightModule('uart');
}
let spiBusy = false;
let spiError = false;
let spiData = '';
let spiSpeed = 1000000;
let spiMode = 0;

function setSPISpeed() {
    spiSpeed = parseInt(document.getElementById('spi-speed').value);
    addLog('SPI Speed set: ' + spiSpeed);
    highlightModule('spi');
}
function setSPIMode() {
    spiMode = parseInt(document.getElementById('spi-mode').value);
    addLog('SPI Mode set: ' + spiMode);
    highlightModule('spi');
}
function sendSPI() {
    let data = document.getElementById('spi-send').value;
    spiBusy = true;
    document.getElementById('spi-status').textContent = 'Sent: ' + data;
    document.getElementById('spi-busy').textContent = 'Busy: true';
    addLog('SPI Send: ' + data);
    highlightModule('spi');
    setTimeout(() => {
        spiBusy = false;
        spiError = false;
        spiData = data;
        document.getElementById('spi-dr').textContent = data;
        document.getElementById('spi-sr').textContent = '0x01';
        document.getElementById('spi-busy').textContent = 'Busy: false';
        document.getElementById('spi-error').textContent = 'Error: false';
    }, 400);
}
function resetSPI() {
    spiBusy = false;
    spiError = false;
    spiData = '';
    document.getElementById('spi-status').textContent = 'Status: Reset';
    document.getElementById('spi-busy').textContent = 'Busy: false';
    document.getElementById('spi-error').textContent = 'Error: false';
    document.getElementById('spi-dr').textContent = '0x00';
    document.getElementById('spi-sr').textContent = '0x00';
    document.getElementById('spi-recv').textContent = 'Received Data: ';
    addLog('SPI Reset');
    highlightModule('spi');
}
function receiveSPI() {
    document.getElementById('spi-recv').textContent = 'Received Data: ' + spiData;
    addLog('SPI Receive: ' + spiData);
    highlightModule('spi');
}
let i2cBusy = false;
let i2cError = false;
let i2cData = '';
let i2cSpeed = 100000;
let i2cAddr = '0x00';

function setI2CSpeed() {
    i2cSpeed = parseInt(document.getElementById('i2c-speed').value);
    addLog('I2C Speed set: ' + i2cSpeed);
    highlightModule('i2c');
}
function setI2CAddr() {
    i2cAddr = document.getElementById('i2c-addr').value;
    addLog('I2C Address set: ' + i2cAddr);
    highlightModule('i2c');
}
function sendI2C() {
    let data = document.getElementById('i2c-send').value;
    i2cBusy = true;
    document.getElementById('i2c-status').textContent = 'Sent: ' + data;
    document.getElementById('i2c-busy').textContent = 'Busy: true';
    addLog('I2C Send: ' + data);
    highlightModule('i2c');
    setTimeout(() => {
        i2cBusy = false;
        i2cError = false;
        i2cData = data;
        document.getElementById('i2c-dr').textContent = data;
        document.getElementById('i2c-sr').textContent = '0x01';
        document.getElementById('i2c-busy').textContent = 'Busy: false';
        document.getElementById('i2c-error').textContent = 'Error: false';
    }, 400);
}
function resetI2C() {
    i2cBusy = false;
    i2cError = false;
    i2cData = '';
    document.getElementById('i2c-status').textContent = 'Status: Reset';
    document.getElementById('i2c-busy').textContent = 'Busy: false';
    document.getElementById('i2c-error').textContent = 'Error: false';
    document.getElementById('i2c-dr').textContent = '0x00';
    document.getElementById('i2c-sr').textContent = '0x00';
    document.getElementById('i2c-recv').textContent = 'Received Data: ';
    addLog('I2C Reset');
    highlightModule('i2c');
}
function receiveI2C() {
    document.getElementById('i2c-recv').textContent = 'Received Data: ' + i2cData;
    addLog('I2C Receive: ' + i2cData);
    highlightModule('i2c');
}
let timerRunning = false;
let timerInt = false;
let timerValue = 0;

function setTimer() {
    timerValue = parseInt(document.getElementById('timer-value').value);
    document.getElementById('timer-status').textContent = 'Timer set to: ' + timerValue;
    document.getElementById('timer-cnt').textContent = timerValue;
    document.getElementById('timer-sr').textContent = '0x01';
    addLog('Timer set: ' + timerValue);
    highlightModule('timer');
}
function startTimer() {
    timerRunning = true;
    document.getElementById('timer-status').textContent = 'Status: Running';
    document.getElementById('timer-running').textContent = 'Running: true';
    addLog('Timer started');
    highlightModule('timer');
}
function stopTimer() {
    timerRunning = false;
    document.getElementById('timer-status').textContent = 'Status: Stopped';
    document.getElementById('timer-running').textContent = 'Running: false';
    addLog('Timer stopped');
    highlightModule('timer');
}
function resetTimer() {
    timerRunning = false;
    timerInt = false;
    timerValue = 0;
    document.getElementById('timer-status').textContent = 'Status: Reset';
    document.getElementById('timer-running').textContent = 'Running: false';
    document.getElementById('timer-int').textContent = 'Interrupt: false';
    document.getElementById('timer-cnt').textContent = '0';
    document.getElementById('timer-sr').textContent = '0x00';
    addLog('Timer reset');
    highlightModule('timer');
}
function sendDMA() {
    let data = document.getElementById('dma-send').value;
    document.getElementById('dma-status').textContent = 'Sent: ' + data;
    addLog('DMA Send: ' + data);
    highlightModule('dma');
    document.getElementById('dma-ccr').textContent = '0x01';
    document.getElementById('dma-cndtr').textContent = '0x10';
    document.getElementById('dma-cpar').textContent = '0x20';
    document.getElementById('dma-cmar').textContent = '0x30';
}

function uartToDma() {
    // read desired SRAM dest and length
    const cmar = parseInt(document.getElementById('dma-uart-cmar').value) || 128;
    const cndtr = parseInt(document.getElementById('dma-uart-cndtr').value) || 16;
    addLog('Starting UART â†’ DMA transfer: cmar=' + cmar + ' len=' + cndtr);
    // ensure UART data is sent/stored first (UI's sendUART stores uart_state on server)
    // trigger DMA transfer from UART peripheral base 0x40000000
    apiCall('/api/dma', { action: 'transfer', cpar: 0x40000000, cmar: cmar, cndtr: cndtr }, (resp) => {
        addLog('DMA transfer response: ' + JSON.stringify(resp));
        // read back SRAM region
        fetch('/api/sram/read?addr=' + cmar + '&len=' + cndtr).then(r => r.json()).then(obj => {
            if (obj && obj.data) {
                const hex = obj.data.map(b => ('0x' + (b&0xFF).toString(16).padStart(2,'0'))).join(',');
                document.getElementById('dma-status').textContent = 'Last DMA read: ' + hex;
                addLog('SRAM[' + obj.addr + ':' + obj.len + '] = ' + hex);
            } else {
                addLog('Failed to read SRAM back.');
            }
        }).catch(() => addLog('Error reading SRAM'));
    });
}

let can1Busy = false, can2Busy = false;
let can1Error = false, can2Error = false;
let can1TxData = '', can2TxData = '';
let can1RxData = '', can2RxData = '';
let can1Baud = 500000, can2Baud = 500000;

function setCANBaud(id) {
    if (id === 1) {
        can1Baud = parseInt(document.getElementById('can1-baud').value);
        // call backend
        apiCall('/api/can/set', { node: 1, baud: can1Baud }, (resp) => {
            addLog('CAN1 Baudrate set: ' + can1Baud + ' (backend)');
        });
        highlightModule('can1');
    } else {
        can2Baud = parseInt(document.getElementById('can2-baud').value);
        apiCall('/api/can/set', { node: 2, baud: can2Baud }, (resp) => {
            addLog('CAN2 Baudrate set: ' + can2Baud + ' (backend)');
        });
        highlightModule('can2');
    }
}
function sendCAN(id) {
    if (id === 1) {
        let data = document.getElementById('can1-tx').value;
        // parse id/dlc/extended/data
        let idval = parseInt(document.getElementById('can1-id').value);
        let dlc = parseInt(document.getElementById('can1-dlc').value);
        let ext = document.getElementById('can1-ext').checked;
        let raw = document.getElementById('can1-tx').value.split(',').map(s => s.trim()).filter(s => s.length).map(s => parseInt(s,16));
        can1Busy = true;
        document.getElementById('can1-status').textContent = 'Transmit to CAN2: ' + data;
        document.getElementById('can1-busy').textContent = 'Busy: true';
        addLog('CAN1 Transmit to CAN2: ' + data);
        highlightModule('can1');
        apiCall('/api/can/send', { src:1, id: idval, dlc: dlc, extended: ext, data: raw }, (resp) => {
            setTimeout(() => {
                can1Busy = false;
                can1Error = false;
                can1TxData = data;
                document.getElementById('can1-txreg').textContent = data;
                document.getElementById('can1-busy').textContent = 'Busy: false';
                document.getElementById('can1-error').textContent = 'Error: false';
                // fetch on CAN2 to populate rxreg
                apiCall('/api/can/recv', { node: 2 }, (r2) => {
                    if (!r2.empty) {
                        let bytes = (r2.frame.data||[]).map(b => ('0x' + (b&0xFF).toString(16).padStart(2,'0'))).join(',');
                        document.getElementById('can2-rxreg').textContent = bytes;
                        can2RxData = bytes;
                    }
                });
            }, 200);
        });
    } else {
        let data = document.getElementById('can2-tx').value;
        let idval = parseInt(document.getElementById('can2-id').value);
        let dlc = parseInt(document.getElementById('can2-dlc').value);
        let ext = document.getElementById('can2-ext').checked;
        let raw = document.getElementById('can2-tx').value.split(',').map(s => s.trim()).filter(s => s.length).map(s => parseInt(s,16));
        can2Busy = true;
        document.getElementById('can2-status').textContent = 'Transmit to CAN1: ' + data;
        document.getElementById('can2-busy').textContent = 'Busy: true';
        addLog('CAN2 Transmit to CAN1: ' + data);
        highlightModule('can2');
        apiCall('/api/can/send', { src:2, id: idval, dlc: dlc, extended: ext, data: raw }, (resp) => {
            setTimeout(() => {
                can2Busy = false;
                can2Error = false;
                can2TxData = data;
                document.getElementById('can2-txreg').textContent = data;
                document.getElementById('can2-busy').textContent = 'Busy: false';
                document.getElementById('can2-error').textContent = 'Error: false';
                apiCall('/api/can/recv', { node: 1 }, (r1) => {
                    if (!r1.empty) {
                        let bytes = (r1.frame.data||[]).map(b => ('0x' + (b&0xFF).toString(16).padStart(2,'0'))).join(',');
                        document.getElementById('can1-rxreg').textContent = bytes;
                        can1RxData = bytes;
                    }
                });
            }, 200);
        });
    }
}
function resetCAN(id) {
    if (id === 1) {
        can1Busy = false;
        can1Error = false;
        can1TxData = '';
        can1RxData = '';
        document.getElementById('can1-status').textContent = 'Status: Reset';
        document.getElementById('can1-busy').textContent = 'Busy: false';
        document.getElementById('can1-error').textContent = 'Error: false';
        document.getElementById('can1-txreg').textContent = '0x00';
        document.getElementById('can1-rxreg').textContent = '0x00';
        document.getElementById('can1-recv').textContent = 'Received Data: ';
        addLog('CAN1 Reset');
        highlightModule('can1');
    } else {
        can2Busy = false;
        can2Error = false;
        can2TxData = '';
        can2RxData = '';
        document.getElementById('can2-status').textContent = 'Status: Reset';
        document.getElementById('can2-busy').textContent = 'Busy: false';
        document.getElementById('can2-error').textContent = 'Error: false';
        document.getElementById('can2-txreg').textContent = '0x00';
        document.getElementById('can2-rxreg').textContent = '0x00';
        document.getElementById('can2-recv').textContent = 'Received Data: ';
        addLog('CAN2 Reset');
        highlightModule('can2');
    }
}
function receiveCAN(id) {
    if (id === 1) {
        document.getElementById('can1-recv').textContent = 'Received Data: ' + can1RxData;
        addLog('CAN1 Receive: ' + can1RxData);
        highlightModule('can1');
    } else {
        document.getElementById('can2-recv').textContent = 'Received Data: ' + can2RxData;
        addLog('CAN2 Receive: ' + can2RxData);
        highlightModule('can2');
    }
}
</script>
</body>
</html>
